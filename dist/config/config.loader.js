import { readFileSync, existsSync } from "fs";
import { join } from "path";
import { homedir } from "os";
import { ConfigSchema } from "./config.schema.js";
const CONFIG_FILE_NAME = "config.json";
export function loadConfig() {
    // Priority: env vars > 1. MCP_CONFIG_PATH > 2. ~/.mcp-dataverse/config.json > 3. cwd/config.json
    const defaultConfigPath = join(homedir(), ".mcp-dataverse", CONFIG_FILE_NAME);
    const configPath = process.env["MCP_CONFIG_PATH"] ??
        (existsSync(defaultConfigPath) ? defaultConfigPath : join(process.cwd(), CONFIG_FILE_NAME));
    let rawConfig = {};
    if (existsSync(configPath)) {
        const fileContent = readFileSync(configPath, "utf-8");
        try {
            rawConfig = JSON.parse(fileContent);
        }
        catch {
            throw new Error(`Invalid JSON in ${configPath}. Check for syntax errors (trailing commas, missing quotes).`);
        }
    }
    // Override with env vars if present.
    // Accepts both SCREAMING_SNAKE_CASE (documented, server.json) and camelCase
    // (generated by VS Code when it reads config.example.json from the npm package).
    const envUrl = process.env["DATAVERSE_ENV_URL"] ?? process.env["environmentUrl"];
    if (envUrl)
        rawConfig["environmentUrl"] = envUrl;
    const timeoutMs = process.env["REQUEST_TIMEOUT_MS"] ?? process.env["requestTimeoutMs"];
    if (timeoutMs)
        rawConfig["requestTimeoutMs"] = Number(timeoutMs);
    const maxRetries = process.env["MAX_RETRIES"] ?? process.env["maxRetries"];
    if (maxRetries)
        rawConfig["maxRetries"] = Number(maxRetries);
    const result = ConfigSchema.safeParse(rawConfig);
    if (!result.success) {
        throw new Error(`Invalid configuration:\n${result.error.issues.map((i) => `  - ${i.path.join(".")}: ${i.message}`).join("\n")}`);
    }
    return result.data;
}
//# sourceMappingURL=config.loader.js.map